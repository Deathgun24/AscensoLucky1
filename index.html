<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STATUS UNACEM</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .table-clickable td {
            cursor: pointer;
        }
        .check { color: green; }
        .cross { color: red; }
        #report { margin-top: 20px; }
        .section-header {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #000;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .report-section {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
        }
        .report-header {
            font-weight: bold;
            color: white;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .report-item {
            margin-bottom: 5px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .report-supervisors {
            font-style: italic;
            color: #6c757d;
        }
        .clear-btn {
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .column-header {
            text-align: center;
            min-height: 40px;
            min-width: 150px;
            padding: 5px;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        .button-row th {
            text-align: center;
            min-width: 150px;
            padding: 5px;
        }
        #statusTable th, #statusTable td {
            min-width: 150px;
            padding: 5px;
        }
        .table-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            margin: 0;
            padding: 0;
        }
        #statusTable {
            width: 100%;
            table-layout: auto;
        }
        .container {
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body style="background-color: #ab49cc;">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0" style="color: rgb(244, 244, 244);">STATUS UNACEM-LUCKY</h2>
            <h4 class="mb-0" style="color: rgb(244, 244, 244);" id="currentDate"></h4>
        </div>
        <div id="loadingIndicator" class="text-center mb-3">
            <span class="loading"></span> Cargando datos...
        </div>
        <div class="table-container">
            <table id="statusTable" class="table table-bordered table-hover table-clickable" style="display: none; background-color: white;">
                <thead>
                    <tr class="section-header">
                        <th colspan="2"></th>
                        <th colspan="2" style="background-color: #c3e6cb;">RETAIL</th>
                        <th colspan="3" style="background-color: #ffcccc;">SIDERPERÚ</th>
                        <th colspan="2" style="background-color: #cce5ff;">OBRAS</th>
                        <th colspan="2" style="background-color: #e6cce6;">PRECIOS</th>
                        <th colspan="2" style="background-color: #cceeff;">INDEPENDIENTES</th>
                        <th colspan="2" style="background-color: #ffe6cc;">PLANNING</th>
                    </tr>
                    <tr id="headerRow">
                        <th class="column-header">Controller</th>
                        <th class="column-header">Supervisor</th>
                        <!-- Los encabezados de columna se generarán dinámicamente -->
                    </tr>
                    <tr id="buttonRow" class="button-row">
                        <th></th>
                        <th></th>
                        <!-- Los botones de limpiar se generarán dinámicamente -->
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                        <td>Aydee Teofila Humaran Iasto</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                        <td>Deborah Caballero Gutierrez</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                        <td>GICELA MARLENI PICHILINGUE MORENO</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                        <td>JACKELINE TATIANA CHERRES BRUNO</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                        <td>JOSE MANUEL INOÑAN VALDIVIEZO</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                        <td>LUCERO ELIZABETH MALAVER TAFUR</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                        <td>PILAR GRACIELA DOROTEO ALVARADO</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>KAREN YEMIMA TAMI PISCOYA</td>
                        <td>CARMEN MARTHA BENITEZ CUCHO</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                        <td>LUZMILA ANTONIO GARCIA</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>KAREN YEMIMA TAMI PISCOYA</td>
                        <td>MARLENY ROSALIA PEREZ SOLANO</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>KAREN YEMIMA TAMI PISCOYA</td>
                        <td>NANCY KARINA ORE HUAYTALLA</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>KAREN YEMIMA TAMI PISCOYA</td>
                        <td>SUSAN CARLA NEYRA ANCHANTTE</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>KAREN YEMIMA TAMI PISCOYA</td>
                        <td>YVETTE YVONNE HERNANDEZ COLAN</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                        <td>CESAR LUIS PANDURO MELENDEZ</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                        <td>DAYSI CARINA MORON ALMENGOR</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                        <td>FRANCIS PAUL RIOS ZUÑIGA</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                        <td>HENRY DAVID LOPEZ REATEGUI</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                        <td>MARICARMEN AYALA ELME</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="text-center mt-3">
            <button id="generateReportBtn" class="btn btn-primary me-2">Generar Reporte Faltantes</button>
            <button id="captureTableBtn" class="btn btn-success">Capturar Tabla como Imagen</button>
        </div>
        <div id="report" class="mt-4"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDC2HMJe8BSHoGRTIthn25c0HWLKM0QrYA",
            authDomain: "status-uncaem.firebaseapp.com",
            databaseURL: "https://status-uncaem-default-rtdb.firebaseio.com",
            projectId: "status-uncaem",
            storageBucket: "status-uncaem.firebasestorage.app",
            messagingSenderId: "1056681054588",
            appId: "1:1056681054588:web:bb329275f9295dba06d4f9",
            measurementId: "G-L96KP4TW01"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const tableRef = ref(database, 'tableState');

        const table = document.getElementById('statusTable');
        const headerRow = document.getElementById('headerRow');
        const buttonRow = document.getElementById('buttonRow');
        const tbody = table.getElementsByTagName('tbody')[0];
        const loadingIndicator = document.getElementById('loadingIndicator');
        const currentDateElement = document.getElementById('currentDate');

        // Nombres de las columnas (13 columnas dinámicas)
        const columnNames = [
            'Enviado', 'Recibido', 
            'Encuestas', 'Compras', 'Material POP', 
            'Recibidas', 'Enviadas', 
            'Recibido', 'Enviado', 
            'Recibido', 'Enviado', 
            'Recibido', 'Enviado'
        ];

        // Crear encabezados de columna y botones de limpiar
        function createColumnHeaders() {
            // Limpiar encabezados existentes (excepto las primeras 2 columnas)
            while (headerRow.cells.length > 2) {
                headerRow.deleteCell(2);
            }
            while (buttonRow.cells.length > 2) {
                buttonRow.deleteCell(2);
            }
            
            // Agregar encabezados y botones
            columnNames.forEach((name, index) => {
                // Crear celda para el encabezado
                const thHeader = document.createElement('th');
                thHeader.className = 'column-header';
                thHeader.textContent = name;
                headerRow.appendChild(thHeader);

                // Crear celda para el botón
                const thButton = document.createElement('th');
                thButton.className = 'button-row';
                const button = document.createElement('button');
                button.className = 'btn btn-sm btn-outline-danger clear-btn';
                button.title = 'Limpiar toda la columna';
                button.innerHTML = '<i class="fas fa-times"></i>';
                button.onclick = function(e) {
                    e.stopPropagation();
                    clearColumn(index + 2);
                };
                thButton.appendChild(button);
                buttonRow.appendChild(thButton);
            });
        }

        // Limpiar toda una columna
        function clearColumn(columnIndex) {
            if (confirm('¿Estás seguro de que quieres limpiar toda esta columna?')) {
                const updates = {};
                
                for (let i = 0; i < tbody.rows.length; i++) {
                    const key = `${i}-${columnIndex}`;
                    updates[`tableState/${key}`] = null;
                    
                    // Limpiar visualmente
                    const cell = tbody.rows[i].cells[columnIndex];
                    cell.innerHTML = '';
                    cell.classList.remove('check', 'cross');
                }
                
                // Actualizar Firebase
                update(ref(database), updates)
                    .catch((error) => {
                        console.error("Error al limpiar columna:", error);
                        alert("Error al limpiar la columna. Por favor recarga la página.");
                    });
            }
        }

        // Mostrar fecha actual
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDateElement.textContent = now.toLocaleDateString('es-ES', options);
        }

        // Mostrar la tabla cuando los datos estén listos
        function showTable() {
            table.style.display = 'table';
            loadingIndicator.style.display = 'none';
        }

        // Cargar datos desde Firebase
        function loadState() {
            onValue(tableRef, (snapshot) => {
                const state = snapshot.val();
                
                if (state) {
                    for (let i = 0; i < tbody.rows.length; i++) {
                        const rowCells = tbody.rows[i].cells;
                        for (let j = 2; j < rowCells.length; j++) {
                            const key = `${i}-${j}`;
                            if (state[key] === 'check') {
                                rowCells[j].innerHTML = '<i class="fas fa-check check"></i>';
                                rowCells[j].classList.add('check');
                            } else if (state[key] === 'cross') {
                                rowCells[j].innerHTML = '<i class="fas fa-times cross"></i>';
                                rowCells[j].classList.add('cross');
                            } else {
                                rowCells[j].innerHTML = '';
                                rowCells[j].classList.remove('check', 'cross');
                            }
                        }
                    }
                }
                showTable();
            }, {
                onlyOnce: false
            });
        }

        // Configurar eventos de clic para las celdas
        function setupCellClickEvents() {
            for (let i = 0; i < tbody.rows.length; i++) {
                const row = tbody.rows[i];
                for (let j = 2; j < row.cells.length; j++) {
                    const cell = row.cells[j];
                    // Debug: Confirmar que se agrega el listener a la última columna
                    if (j === 14) {
                        console.log(`Adding click listener to cell at row ${i}, column ${j} (Planning - Enviado)`);
                    }
                    cell.addEventListener('click', function() {
                        const rowIndex = i;
                        const cellIndex = j;
                        const key = `${rowIndex}-${cellIndex}`;
                        
                        if (this.classList.contains('check')) {
                            this.innerHTML = '<i class="fas fa-times cross"></i>';
                            this.classList.remove('check');
                            this.classList.add('cross');
                            saveState(key, 'cross');
                        } else if (this.classList.contains('cross')) {
                            this.innerHTML = '';
                            this.classList.remove('cross');
                            saveState(key, '');
                        } else {
                            this.innerHTML = '<i class="fas fa-check check"></i>';
                            this.classList.add('check');
                            saveState(key, 'check');
                        }
                    });
                }
            }
        }

        // Guardar estado en Firebase
        function saveState(key, value) {
            set(ref(database, `tableState/${key}`), value)
                .catch((error) => {
                    console.error("Error al guardar en Firebase:", error);
                    alert("Error al guardar los cambios. Por favor recarga la página.");
                });
        }

        // Generar reporte
        document.getElementById('generateReportBtn').addEventListener('click', function() {
            const report = {};
            const headers = Array.from(table.rows[1].cells).slice(2);

            // Mapeo de columnas a secciones
            const columnToSection = [
                {start: 2, end: 3, section: 'RETAIL'},
                {start: 4, end: 6, section: 'SIDERPERÚ'},
                {start: 7, end: 8, section: 'OBRAS'},
                {start: 9, end: 10, section: 'PRECIOS'},
                {start: 11, end: 12, section: 'INDEPENDIENTES'},
                {start: 13, end: 14, section: 'PLANNING'}
            ];

            for (let i = 0; i < tbody.rows.length; i++) {
                const controller = tbody.rows[i].cells[0].textContent;
                const supervisor = tbody.rows[i].cells[1].textContent;
                const statusCells = Array.from(tbody.rows[i].cells).slice(2);

                statusCells.forEach((cell, cellIndex) => {
                    const globalIndex = cellIndex + 2;
                    
                    if (cell.classList.contains('cross')) {
                        const sectionInfo = columnToSection.find(s => 
                            globalIndex >= s.start && globalIndex <= s.end
                        );
                        
                        if (sectionInfo) {
                            const header = headers[cellIndex].textContent;
                            const fullHeader = `${sectionInfo.section} - ${header}`;
                            
                            if (!report[fullHeader]) report[fullHeader] = {};
                            if (!report[fullHeader][controller]) report[fullHeader][controller] = [];
                            report[fullHeader][controller].push(supervisor);
                        }
                    }
                });
            }

            let reportHtml = '<h4 class="text-center mb-4">Reporte de Faltantes</h4>';
            
            if (Object.keys(report).length === 0) {
                reportHtml += '<div class="alert alert-success text-center">No hay elementos faltantes.</div>';
            } else {
                const sectionColors = {
                    'RETAIL': '#c3e6cb',
                    'SIDERPERÚ': '#ffcccc',
                    'OBRAS': '#cce5ff',
                    'PRECIOS': '#e6cce6',
                    'INDEPENDIENTES': '#cceeff',
                    'PLANNING': '#ffe6cc'
                };

                const groupedReport = {};
                for (let header in report) {
                    const mainSection = header.split(' - ')[0];
                    if (!groupedReport[mainSection]) {
                        groupedReport[mainSection] = {};
                    }
                    groupedReport[mainSection][header] = report[header];
                }

                for (let section in groupedReport) {
                    reportHtml += `<div class="report-section">
                        <div class="report-header" style="background-color: ${sectionColors[section]}">${section}</div>`;
                    
                    for (let header in groupedReport[section]) {
                        const task = header.split(' - ')[1];
                        reportHtml += `<div class="mb-3">
                            <h5>${task}</h5>`;
                        
                        for (let controller in groupedReport[section][header]) {
                            const supervisors = groupedReport[section][header][controller].join(', ');
                            reportHtml += `<div class="report-item">
                                <strong>Controller:</strong> ${controller}<br>
                                <span class="report-supervisors">Supervisores: ${supervisors}</span>
                            </div>`;
                        }
                        
                        reportHtml += `</div>`;
                    }
                    
                    reportHtml += `</div>`;
                }
            }
            
            document.getElementById('report').innerHTML = reportHtml;
        });

        // Capturar tabla como imagen
        document.getElementById('captureTableBtn').addEventListener('click', function() {
            const table = document.getElementById('statusTable');
            // Asegurar que la tabla esté visible
            table.style.display = 'table';
            
            // Usar html2canvas para capturar la tabla
            html2canvas(table, {
                scrollX: 0,
                scrollY: 0,
                width: table.scrollWidth, // Capturar todo el ancho de la tabla
                height: table.scrollHeight, // Capturar toda la altura de la tabla
                scale: 2 // Mejorar la resolución
            }).then(canvas => {
                // Crear un enlace para descargar la imagen
                const link = document.createElement('a');
                link.download = 'tabla_status_unacem.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                console.error("Error al capturar la tabla:", error);
                alert("Error al capturar la tabla. Por favor intenta de nuevo.");
            });
        });

        // Inicializar la aplicación
        createColumnHeaders();
        updateCurrentDate();
        setupCellClickEvents();
        loadState();
    </script>
</body>
</html>