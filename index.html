<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla Interactiva - Empresa</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK (no modular) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
    <style>
        .table-clickable td {
            cursor: pointer;
        }
        .check { color: green; }
        .cross { color: red; }
        #report { margin-top: 20px; }
        .section-header {
            font-weight: bold;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="text-center mb-4">Estado de Tareas - Empresa</h2>
        <table id="statusTable" class="table table-bordered table-hover table-clickable">
            <thead>
                <tr class="section-header">
                    <th colspan="2"></th>
                    <th colspan="1" style="background-color: #c3e6cb;">RETAIL</th>
                    <th colspan="3" style="background-color: #ffcccc;">SIDERPERÚ</th>
                    <th colspan="2" style="background-color: #cce5ff;">OBRAS</th>
                    <th colspan="2" style="background-color: #e6cce6;">PRECIOS</th>
                    <th colspan="2" style="background-color: #cceeff;">INDEPENDIENTES</th>
                    <th colspan="2" style="background-color: #ffe6cc;">PLANNING</th>
                </tr>
                <tr>
                    <th>Controller</th>
                    <th>Supervisor</th>
                    <th>Recibo</th>
                    <th>Encuestas</th>
                    <th>Compras</th>
                    <th>Material POP</th>
                    <th>Recibidas</th>
                    <th>Enviadas</th>
                    <th>Recibido</th>
                    <th>Enviado</th>
                    <th>Recibido</th>
                    <th>Enviado</th>
                    <th>Recibido</th>
                    <th>Enviado</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Elizabeth Cristina Llallicco Lopez</td>
                    <td>Aydee Teofila Humaran Iasto</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>Elizabeth Cristina Llallicco Lopez</td>
                    <td>Deborah Caballero Gutierrez</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                    <td>GICELA MARLENI PICHILINGUE MORENO</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                    <td>JACKELINE TATIANA CHERRES BRUNO</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                    <td>JOSE MANUEL INOÑAN VALDIVIEZO</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                    <td>LUCERO ELIZABETH MALAVER TAFUR</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>ELIZABETH CRISTINA LLALLICO LOPEZ</td>
                    <td>PILAR GRACIELA DOROTEO ALVARADO</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>KAREN YEMIMA TAMI PISCOYA</td>
                    <td>CARMEN MARTHA BENITEZ CUCHO</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>KAREN YEMIMA TAMI PISCOYA</td>
                    <td>LUZMILA ANTONIO GARCIA</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>KAREN YEMIMA TAMI PISCOYA</td>
                    <td>MARLENY ROSALIA PEREZ SOLANO</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>KAREN YEMIMA TAMI PISCOYA</td>
                    <td>NANCY KARINA ORE HUAYTALLA</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>KAREN YEMIMA TAMI PISCOYA</td>
                    <td>SUSAN CARLA NEYRA ANCHANTTE</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>KAREN YEMIMA TAMI PISCOYA</td>
                    <td>YVETTE YVONNE HERNANDEZ COLAN</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                    <td>CESAR LUIS PANDURO MELENDEZ</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                    <td>DAYSI CARINA MORON ALMENGOR</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                    <td>FRANCIS PAUL RIOS ZUÑIGA</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                    <td>HENRY DAVID LOPEZ REATEGUI</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <td>YULIANHA ROSALLY CASTILLO JULCA</td>
                    <td>MARICARMEN AYALA ELME</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
            </tbody>
        </table>
        <div class="text-center">
            <button id="generateReportBtn" class="btn btn-primary">Generar Reporte</button>
        </div>
        <div id="report" class="mt-4"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuración de Firebase con tu proyecto
        const firebaseConfig = {
            apiKey: "AIzaSyDC2HMJe8BSHoGRTIthn25c0HWLKM0QrYA",
            authDomain: "status-uncaem.firebaseapp.com",
            databaseURL: "https://status-uncaem-default-rtdb.firebaseio.com",
            projectId: "status-uncaem",
            storageBucket: "status-uncaem.firebasestorage.app",
            messagingSenderId: "1056681054588",
            appId: "1:1056681054588:web:bb329275f9295dba06d4f9",
            measurementId: "G-L96KP4TW01"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tableRef = db.ref('tableState'); // Nodo donde se guarda el estado

        const table = document.getElementById('statusTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const cells = tbody.getElementsByTagName('td');

        // Cargar datos de Firebase al iniciar (en tiempo real)
        function loadState() {
            tableRef.on('value', (snapshot) => {
                const state = snapshot.val() || {};
                for (let i = 0; i < tbody.rows.length; i++) {
                    const rowCells = tbody.rows[i].cells;
                    for (let j = 2; j < rowCells.length; j++) {
                        const key = `${i}-${j}`;
                        const value = state[key];
                        const cell = rowCells[j];
                        if (value === 'check') {
                            cell.innerHTML = '<i class="fas fa-check check"></i>';
                            cell.classList.add('check');
                            cell.classList.remove('cross');
                        } else if (value === 'cross') {
                            cell.innerHTML = '<i class="fas fa-times cross"></i>';
                            cell.classList.add('cross');
                            cell.classList.remove('check');
                        } else {
                            cell.innerHTML = '';
                            cell.classList.remove('check', 'cross');
                        }
                    }
                }
            }, (error) => {
                console.error("Error loading state:", error);
            });
        }

        // Guardar estado al hacer clic
        for (let cell of cells) {
            if (cell.cellIndex > 1) {
                cell.addEventListener('click', function() {
                    const row = this.parentElement;
                    const rowIndex = Array.from(tbody.rows).indexOf(row); // Índice correcto dentro del tbody
                    const cellIndex = this.cellIndex;
                    const key = `${rowIndex}-${cellIndex}`;
                    let value;
                    if (this.classList.contains('check')) {
                        this.innerHTML = '<i class="fas fa-times cross"></i>';
                        this.classList.remove('check');
                        this.classList.add('cross');
                        value = 'cross';
                    } else if (this.classList.contains('cross')) {
                        this.innerHTML = '';
                        this.classList.remove('cross');
                        value = '';
                    } else {
                        this.innerHTML = '<i class="fas fa-check check"></i>';
                        this.classList.add('check');
                        value = 'check';
                    }
                    // Guardar en Firebase inmediatamente después del cambio
                    tableRef.child(key).set(value)
                        .then(() => console.log(`Saved ${key}: ${value}`))
                        .catch((error) => console.error(`Error saving ${key}:`, error));
                });
            }
        }

        // Generar reporte
        document.getElementById('generateReportBtn').addEventListener('click', function() {
            const report = {};
            const headers = Array.from(table.rows[1].cells).slice(2); // Segunda fila de encabezados

            for (let i = 0; i < tbody.rows.length; i++) {
                const controller = tbody.rows[i].cells[0].textContent;
                const supervisor = tbody.rows[i].cells[1].textContent;
                const statuses = Array.from(tbody.rows[i].cells).slice(2).map(cell => cell.className);

                headers.forEach((header, index) => {
                    if (statuses[index] === 'cross') { // Solo procesa las casillas con X
                        const sectionMap = {
                            'Recibo': 'RETAIL',
                            'Encuestas': 'SIDERPERÚ',
                            'Compras': 'SIDERPERÚ',
                            'Material POP': 'SIDERPERÚ',
                            'Recibidas': 'OBRAS',
                            'Enviadas': 'OBRAS',
                            'Recibido': index === 8 ? 'PRECIOS' : (index === 10 ? 'INDEPENDIENTES' : (index === 12 ? 'PLANNING' : '')),
                            'Enviado': index === 9 ? 'PRECIOS' : (index === 11 ? 'INDEPENDIENTES' : (index === 13 ? 'PLANNING' : ''))
                        };
                        const section = sectionMap[header.textContent];
                        if (section) {
                            const fullHeader = `${section} ${header.textContent}`;
                            if (!report[fullHeader]) report[fullHeader] = {};
                            if (!report[fullHeader][controller]) report[fullHeader][controller] = [];
                            report[fullHeader][controller].push(supervisor);
                        }
                    }
                });
            }

            let reportHtml = '<h4 class="text-center">Reporte de Faltantes:</h4>';
            if (Object.keys(report).length === 0) {
                reportHtml += '<p class="text-center text-success">No hay elementos faltantes.</p>';
            } else {
                for (let header in report) {
                    for (let controller in report[header]) {
                        const supervisors = report[header][controller].join(', ');
                        reportHtml += `<p>Falta <strong>${header}</strong> de ${controller} faltan los supervisores: ${supervisors}</p>`;
                    }
                }
            }
            document.getElementById('report').innerHTML = reportHtml;
        });

        // Cargar estado al iniciar la página
        loadState();
    </script>
</body>
</html>